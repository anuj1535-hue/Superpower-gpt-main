class SuperAI{constructor(){this._rewriteSession=null,this._rewriteCreating=null,this._rewriteAvailability="unknown",this._rewriteDownloadProgress=null,this._rewriteLastUsedAt=0,this._promptSession=null,this._promptCreating=null,this._promptAvailability="unknown",this._promptDownloadProgress=null,this._promptLastUsedAt=0,this._promptCreateSignature=null,this._SESSION_TTL_MS=5*60*1e3}isRewriteSupported(){return typeof self<"u"&&"Rewriter"in self}async rewriteAvailability(){if(!this.isRewriteSupported())return"unsupported";try{return this._rewriteAvailability=await self.Rewriter.availability(),this._rewriteAvailability}catch(e){return console.warn({where:"SuperAI.rewriteAvailability",message:"Failed to read Rewriter availability",error:String(e)}),"unavailable"}}async rewrite({text:e,context:r="",tone:a="as-is",length:t="as-is",forceRefresh:i=!1}={}){try{if(!e||typeof e!="string"||!e.trim())return{ok:!1,error:"EMPTY_TEXT"};if(!this.isRewriteSupported())return{ok:!1,error:"Prompt Optimizer is only available in Chrome 137+. Go to chrome://flags/#rewriter-api-for-gemini-nano and set to Enabled"};const l=await this.rewriteAvailability();if(l==="unavailable")return{ok:!1,error:"OPTIMIZER_UNAVAILABLE"};const n=await this._ensureRewriteSession({forceRefresh:i}),s={},p=this._normalizeTone(a),u=this._normalizeLength(t);r&&typeof r=="string"&&r.trim()&&(s.context=r.trim()),p&&(s.tone=p),u&&(s.length=u);const h=await n.rewrite(e,s);return this._rewriteLastUsedAt=Date.now(),{ok:!0,text:typeof h=="string"?h:String(h),meta:{availability:l,usedOptions:{tone:p,length:u,hasContext:!!s.context},downloadProgress:this._rewriteDownloadProgress}}}catch(o){return console.warn({where:"SuperAI.rewrite",message:"Rewrite failed",error:String(o),stack:o&&o.stack?String(o.stack):"no-stack"}),{ok:!1,error:"REWRITE_FAILED"}}}destroyRewrite(){try{this._rewriteSession&&typeof this._rewriteSession.destroy=="function"&&this._rewriteSession.destroy()}catch(e){console.warn({where:"SuperAI.destroyRewrite",message:"Destroy rewrite session failed",error:String(e)})}finally{this._rewriteSession=null,this._rewriteCreating=null}}async _ensureRewriteSession({forceRefresh:e=!1}={}){const r=this._rewriteSession&&Date.now()-this._rewriteLastUsedAt<this._SESSION_TTL_MS;if(!e&&r)return this._rewriteSession;if(this._rewriteCreating)try{return await this._rewriteCreating}catch(t){console.warn({where:"SuperAI._ensureRewriteSession.awaitExistingCreate",error:String(t)})}const a={monitor:t=>{try{t.addEventListener("downloadprogress",i=>{const o=Math.round((Number(i.loaded)||0)*100);this._rewriteDownloadProgress={loaded:Number(i.loaded)||0,total:Number(i.total)||1,percent:o},console.warn({where:"SuperAI.rewrite.monitor.downloadprogress",percent:o})})}catch(i){console.warn({where:"SuperAI.rewrite.monitor.setup",error:String(i)})}}};return this._rewriteCreating=self.Rewriter.create(a).then(t=>(this._rewriteSession=t,this._rewriteLastUsedAt=Date.now(),this._rewriteCreating=null,t)).catch(t=>{throw this._rewriteCreating=null,t}),this._rewriteCreating}_normalizeTone(e){const r=String(e||"").trim().toLowerCase();return r==="more-formal"||r==="formal"?"more-formal":r==="more-casual"||r==="casual"?"more-casual":"as-is"}_normalizeLength(e){const r=String(e||"").trim().toLowerCase();return r==="shorter"||r==="short"?"shorter":r==="longer"||r==="long"?"longer":"as-is"}isPromptSupported(){return typeof self>"u"?!1:"LanguageModel"in self||self.ai&&self.ai.languageModel}async promptAvailability(e={}){if(!this.isPromptSupported())return"unsupported";try{const r=this._getLanguageModelNamespace();return this._promptAvailability=await r.availability(this._sanitizePromptCreateOptions(e)),this._promptAvailability}catch(r){return console.warn({where:"SuperAI.promptAvailability",message:"Failed to read Prompt availability",error:String(r)}),"unavailable"}}async prompt({prompt:e,createOptions:r={},promptOptions:a={},forceRefresh:t=!1}={}){try{const i=Array.isArray(e),o=i&&(!e.length||!e.some(p=>p&&String(p.content||"").trim().length));if(!i&&(!e||!String(e).trim())||o)return{ok:!1,error:"EMPTY_PROMPT"};if(!this.isPromptSupported())return{ok:!1,error:"Go to chrome://flags/#prompt-api-for-gemini-nano and set to Enabled"};const l=await this.promptAvailability(r);if(l==="unavailable")return{ok:!1,error:"PROMPT_UNAVAILABLE"};const s=await(await this._ensurePromptSession({forceRefresh:t,createOptions:r})).prompt(e,a);return this._promptLastUsedAt=Date.now(),{ok:!0,text:typeof s=="string"?s:String(s),meta:{availability:l,usedCreateOptions:this._sanitizePromptCreateOptions(r),downloadProgress:this._promptDownloadProgress}}}catch(i){return console.warn({where:"SuperAI.prompt",message:"Prompt failed",error:String(i),stack:i?.stack||"no-stack"}),{ok:!1,error:"PROMPT_FAILED"}}}async promptStreaming({prompt:e,createOptions:r={},promptOptions:a={},forceRefresh:t=!1}={}){try{const i=Array.isArray(e),o=i&&(!e.length||!e.some(p=>p&&String(p.content||"").trim().length));if(!i&&(!e||!String(e).trim())||o)return{ok:!1,error:"EMPTY_PROMPT"};if(!this.isPromptSupported())return{ok:!1,error:"PROMPT_UNSUPPORTED"};const l=await this.promptAvailability(r);if(l==="unavailable")return{ok:!1,error:"PROMPT_UNAVAILABLE"};const s=await(await this._ensurePromptSession({forceRefresh:t,createOptions:r})).promptStreaming(e,a);return this._promptLastUsedAt=Date.now(),{ok:!0,stream:s,meta:{availability:l,usedCreateOptions:this._sanitizePromptCreateOptions(r),downloadProgress:this._promptDownloadProgress}}}catch(i){return console.warn({where:"SuperAI.promptStreaming",message:"Prompt streaming failed",error:String(i)}),{ok:!1,error:"PROMPT_STREAM_FAILED"}}}async append(e=[],r={}){try{return!Array.isArray(e)||e.length===0?{ok:!1,error:"EMPTY_MESSAGES"}:this.isPromptSupported()?(await this._ensurePromptSession({forceRefresh:!1,createOptions:r}),await this._promptSession.append(e),this._promptLastUsedAt=Date.now(),{ok:!0}):{ok:!1,error:"PROMPT_UNSUPPORTED"}}catch(a){return console.warn({where:"SuperAI.append",message:"Append failed",error:String(a)}),{ok:!1,error:"PROMPT_APPEND_FAILED"}}}async promptParams(){try{return this.isPromptSupported()?{ok:!0,params:await this._getLanguageModelNamespace().params()}:{ok:!1,error:"PROMPT_UNSUPPORTED"}}catch(e){return console.warn({where:"SuperAI.promptParams",message:"Failed to fetch Prompt params",error:String(e)}),{ok:!1,error:"PROMPT_PARAMS_FAILED"}}}destroyPrompt(){try{this._promptSession&&typeof this._promptSession.destroy=="function"&&this._promptSession.destroy()}catch(e){console.warn({where:"SuperAI.destroyPrompt",message:"Destroy prompt session failed",error:String(e)})}finally{this._promptSession=null,this._promptCreating=null,this._promptCreateSignature=null}}async _ensurePromptSession({forceRefresh:e=!1,createOptions:r={}}={}){const a=this._sanitizePromptCreateOptions(r),t=JSON.stringify(a),i=this._promptSession&&Date.now()-this._promptLastUsedAt<this._SESSION_TTL_MS&&this._promptCreateSignature===t;if(!e&&i)return this._promptSession;if(this._promptCreating)try{return await this._promptCreating}catch(n){console.warn({where:"SuperAI._ensurePromptSession.awaitExistingCreate",error:String(n)})}const o=this._getLanguageModelNamespace(),l={...a,monitor:n=>{try{n.addEventListener("downloadprogress",s=>{const p=Math.round((Number(s.loaded)||0)*100);this._promptDownloadProgress={loaded:Number(s.loaded)||0,total:Number(s.total)||1,percent:p},console.warn({where:"SuperAI.prompt.monitor.downloadprogress",percent:p})})}catch(s){console.warn({where:"SuperAI.prompt.monitor.setup",error:String(s)})}}};return this._promptCreating=o.create(l).then(n=>(this._promptSession=n,this._promptCreateSignature=t,this._promptLastUsedAt=Date.now(),this._promptCreating=null,n)).catch(n=>{throw this._promptCreating=null,n}),this._promptCreating}_getLanguageModelNamespace(){if(typeof self<"u"&&self.LanguageModel)return self.LanguageModel;if(typeof self<"u"&&self.ai&&self.ai.languageModel)return self.ai.languageModel;throw new Error("LanguageModel API not available")}_sanitizePromptCreateOptions(e={}){const r={},{temperature:a,topK:t,expectedInputs:i,expectedOutputs:o,initialPrompts:l,systemPrompt:n,signal:s}=e||{};return typeof a=="number"&&(r.temperature=a),typeof t=="number"&&(r.topK=t),Array.isArray(i)&&(r.expectedInputs=i),Array.isArray(o)&&(r.expectedOutputs=o),Array.isArray(l)&&(r.initialPrompts=l),typeof n=="string"&&n.trim()&&(r.systemPrompt=n.trim()),s&&(r.signal=s),r}async detectLanguage(e){if(typeof self>"u"||!("LanguageDetector"in self))return null;try{if(await self.LanguageDetector.availability()==="unavailable")return null;const a=await self.LanguageDetector.create(),[t]=await a.detect(String(e).slice(0,4e3));return a.destroy?.(),t?.detectedLanguage??null}catch{return null}}async promptSameLanguage({prompt:e,createOptions:r={},promptOptions:a={},forceRefresh:t=!1}={}){const i=new Set(["en","ja","es"]);let o=e;Array.isArray(e)&&(o=e.map(s=>String(s.content||"")).join(`
`));const l=await this.detectLanguage(o),n=i.has(l)?l:"en";return this.prompt({prompt:e,createOptions:{...r,expectedInputs:[{type:"text",languages:["en",n]}],expectedOutputs:[{type:"text",languages:[n]}]},promptOptions:a,forceRefresh:t})}}
