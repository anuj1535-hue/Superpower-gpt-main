const originalFetch=window.fetch;window.fetch=async function(...k){const[C,E]=k,h=new Request(C,E),{url:n,method:o,headers:p}=h;if(!["backend-api","public-api","api/auth","ab.chatgpt.com","backend-anon","graphql"].some(e=>n.includes(e)))try{return await originalFetch(h)}catch(e){throw console.error("Fetch request failed:",e),e}const R=["application/json","text/plain"],b=p&&new Headers(p).get("content-type")||"";if(o==="POST"&&b&&!R.some(e=>b.includes(e)))return originalFetch(h);let f="",a={};try{f=await h.clone().text(),a=JSON.parse(f||"{}")}catch{f=E?.body||""}const l=new URLSearchParams(n.split("?")[1]);if((n.endsWith("backend-api/conversation")||n.endsWith("backend-api/f/conversation"))&&o==="POST"){let e=!1;if(a.messages){const t=window.sessionStorage.getItem("sp/selectedModel");t&&(a={...a,model:t},e=!0);const i=window.localStorage.getItem("sp/lastInstruction");if(i&&i!=="null"){const u=JSON.parse(window.localStorage.getItem("sp/instructionsCache")||"{}"),v=a.messages[0].id;u[v]=i,window.localStorage.setItem("sp/instructionsCache",JSON.stringify(u)),window.localStorage.setItem("sp/lastInstruction",null);const d=a.messages.find(w=>w.author.role==="user");if(d){const w=d?.content?.parts.find(m=>typeof m=="string");if(w!==void 0){const m=`${i}${w||""}`;d.content.parts=d.content.parts.map(c=>c===w?m:c),a.messages=a.messages.map(c=>c.id===d.id?d:c)}}e=!0}e&&(f=JSON.stringify(a));const r=new CustomEvent("conversationSubmitted",{detail:{messages:a.messages,instructions:i}});window.dispatchEvent(r)}}const I={...E,method:o,headers:Object.fromEntries(p.entries()),...o!=="GET"&&o!=="HEAD"?{body:f}:{}};let s;try{s=await originalFetch(n,I)}catch(e){return console.error("Fetch request failed:",e),originalFetch(h)}if(n.endsWith("backend-anon/me")||n.endsWith("backend-anon/edge")||n.endsWith("backend-anon/system_hints")){const e=await s.clone().json();if(!e?.email||e?.id?.startsWith("ua-")){window.localStorage.setItem("sp/isLoggedIn","false");const t=new CustomEvent("signoutReceived",{detail:e});window.dispatchEvent(t)}}if(n.endsWith("backend-api/me")){const e=p.get("Authorization"),t=await s.clone().json();if(e&&t?.id&&!t?.id?.startsWith("ua-")){window.localStorage.setItem("sp/isLoggedIn","true");const i=new CustomEvent("authReceived",{detail:{...t,accessToken:e}});window.dispatchEvent(i)}}if(n.endsWith("api/auth/signout")){const e=await s.clone().json();if(e?.success){window.localStorage.setItem("sp/isLoggedIn","false");const t=new CustomEvent("signoutReceived",{detail:e});window.dispatchEvent(t)}}if(n.includes("backend-api/subscriptions?")&&l.get("account_id")){const e=await s.clone().json();if(e?.plan_type){const t=new CustomEvent("subscriptionsReceived",{detail:{...e,accountId:l.get("account_id")}});window.dispatchEvent(t)}}if(n.endsWith("backend-api/stop_conversation")&&o==="POST"){const e=await s.clone().json(),t=new CustomEvent("stopConversationReceived",{detail:e});window.dispatchEvent(t)}if(n.includes("backend-api/gizmos/g-")&&!n.includes("backend-api/gizmos/g-p-")){const e=await s.clone().json();if(e?.detail?.toLowerCase().includes("not found")){const t=new CustomEvent("gizmoNotFound",{detail:n});window.dispatchEvent(t)}else if(e?.gizmo?.id){const t=new CustomEvent("gizmoReceived",{detail:e});window.dispatchEvent(t)}}if(n.includes("backend-api/gizmos/bootstrap")){const e=await s.clone().json(),t=new CustomEvent("gizmosBootstrapReceived",{detail:e});window.dispatchEvent(t)}if(n.includes("public-api/gizmos/discovery")){const e=await s.clone().json();if(e?.cuts){const t=new CustomEvent("gizmoDiscoveryReceived",{detail:e});window.dispatchEvent(t)}}if(n.includes("backend-api/gizmos/g-")&&n.endsWith("sidebar")&&o==="POST"){const e=await s.clone().json(),t=new CustomEvent("gizmoSidebarUpdateReceived",{detail:e});window.dispatchEvent(t)}if(n.includes("backend-api/accounts/check")){const e=p.get("Authorization"),t=await s.clone().json();if(e&&t.accounts){const i=new CustomEvent("accountReceived",{detail:{...t,accessToken:e}});window.dispatchEvent(i)}}if(n.includes("backend-api/files/file")&&n.endsWith("/download")&&o==="GET"){const e=n.split("/files/")[1].split("/download")[0],t=await s.clone().json();if(t){const i=new CustomEvent("fileReceived",{detail:{data:t,fileId:e}});window.dispatchEvent(i)}}if(n.includes("backend-api/files/download/file")&&o==="GET"){const e=n.split("/files/download/")[1].split("?")[0],t=await s.clone().json();if(t){const i=new CustomEvent("fileReceived",{detail:{data:t,fileId:e}});window.dispatchEvent(i)}}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&n.includes("/attachment/file")&&n.endsWith("/download")&&o==="GET"){const e=n.split("/attachment/")[1].split("/download")[0],t=await s.clone().json();if(t){const i=new CustomEvent("fileReceived",{detail:{data:t,fileId:e}});window.dispatchEvent(i)}}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&n.endsWith("/textdocs")&&o==="GET"){const e=n.split("/conversation/")[1].split("/textdocs")[0],t=await s.clone().json();if(t){const i=new CustomEvent("textdocsReceived",{detail:{textdocs:t,conversationId:e}});window.dispatchEvent(i)}}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&o==="PATCH"&&typeof a.gizmo_id=="string"){const e=n.split("/conversation/")[1],t=new CustomEvent("conversationProjectUpdated",{detail:{conversationId:e,gizmoId:a.gizmo_id}});window.dispatchEvent(t)}if(n.includes("backend-api/settings/user")){const e=p.get("Authorization"),t=await s.clone().json();if(window.localStorage.setItem("sp/isLoggedIn","true"),t){const i=new CustomEvent("userSettingsReceived",{detail:{...t,accessToken:e}});window.dispatchEvent(i)}}if(n.includes("backend-api/user_system_messages")&&(o==="PATCH"||o==="POST")){const e=await s.clone().json();if(e){const t=new CustomEvent("profileUpdatedReceived",{detail:{...e}});window.dispatchEvent(t)}}if(n.includes("backend-api/conversations?")&&parseInt(l.get("limit"),10)===28&&parseInt(l.get("offset"),10)%28===0&&(l.get("is_archived")==="false"||l.get("is_archived")===null)){const e=await s.clone().json(),t=new CustomEvent("historyLoadedReceived",{detail:e}),i=Math.floor(parseInt(l.get("offset"),10)/28);setTimeout(()=>{window.dispatchEvent(t)},1e3*i)}if(n.includes("graphql?")){const e=JSON.parse(l.get("variables"));if(e.first===28&&e.after==="aWR4Oi0x"&&e?.isArchived===!1){const t=await s.clone().json(),i=new CustomEvent("historyLoadedReceived",{detail:t});window.dispatchEvent(i)}}if(n.includes("backend-api/gizmos/snorlax/sidebar")){const e=l.get("cursor"),t=await s.clone().json(),i=new CustomEvent("projectsReceived",{detail:{cursor:e,responseData:t}});window.dispatchEvent(i)}if(n.includes("backend-api/conversations")&&a.is_archived===!0&&o==="PATCH"){const e=await s.clone().json(),t=new CustomEvent("archivedAllReceived",{detail:e});window.dispatchEvent(t)}if(n.includes("backend-api/conversations")&&a.is_visible===!1&&o==="PATCH"){const e=await s.clone().json(),t=new CustomEvent("deleteAllReceived",{detail:e});window.dispatchEvent(t)}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&a.is_archived===!1&&o==="PATCH"){const e=n.split("/").pop(),t=new CustomEvent("conversationUnarchivedReceived",{detail:{conversationId:e}});window.dispatchEvent(t)}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&a.is_archived===!0&&o==="PATCH"){const e=n.split("/").pop(),t=new CustomEvent("conversationArchivedReceived",{detail:{conversationId:e}});window.dispatchEvent(t)}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&a.is_visible===!1&&o==="PATCH"){const e=n.split("/").pop(),t=new CustomEvent("conversationDeleteReceived",{detail:{conversationId:e}});window.dispatchEvent(t)}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&Object.keys(a).includes("title")&&o==="PATCH"){const e=n.split("/").pop(),t=new CustomEvent("conversationRenameReceived",{detail:{conversationId:e,title:a.title}});window.dispatchEvent(t)}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&o==="GET"){const e=n.split("/").pop();if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)){const t=await s.clone().json(),i=t.conversation_id||t.id||e;if(i){const r=new CustomEvent("conversationReceived",{detail:{conversation:{...t,conversation_id:i}}});window.dispatchEvent(r)}}}if(n.includes("backend-api/tasks/deepresch_")&&n.endsWith("/stream")){const e=(await s.clone()).body.getReader(),t=new TextDecoder("utf-8");let i=!1;e.read().then(function r({done:u,value:v}){const d=t.decode(v,{stream:!0});if(i=i||d?.includes("final_message"),i){const w=new CustomEvent("deepResearchFinalMessageReceived",{detail:{}});return window.dispatchEvent(w),e.cancel()}return u?e.cancel():e.read().then(r)})}if((n.endsWith("backend-api/conversation")||n.endsWith("backend-api/f/conversation"))&&o==="POST"){const e=(await s.clone()).body.getReader(),t=new TextDecoder("utf-8");let i=!1,r=!1,u="New chat",v;e.read().then(function d({done:w,value:m}){const c=t.decode(m,{stream:!0});if(i=i||c?.includes("message_stream_complete"),r=i&&(r||w||c?.includes("DONE")),i&&!v)try{v=JSON.parse(c.split("data: ")?.[1]).conversation_id}catch{}if(c.includes("title_generation"))try{const g=JSON.parse(c.split("data: ")?.[1]);u=g.title,v||(v=g.conversation_id)}catch{}if(i&&r){const g=new CustomEvent("conversationResponseEnded",{detail:{conversationId:v,conversationTitle:u}});return window.dispatchEvent(g),e.cancel()}return e.read().then(d)})}if((n.includes("backend-api/conversation")||n.includes("backend-api/f/conversation"))&&n.includes("/async-status")&&o==="POST"&&a.status===4){const e=n.split("/conversation/")[1].split("/async-status")[0];if((await s.clone().json()).status==="OK"){const t=new CustomEvent("conversationAsyncMessageReceived",{detail:{conversationId:e}});window.dispatchEvent(t)}}if(n.includes("backend-api/models")){const e=await s.clone().json(),t=p.get("Authorization");if(e.models){const i=new CustomEvent("modelsReceived",{detail:{...e,accessToken:t}});window.dispatchEvent(i)}}if(n.includes("ab.chatgpt.com/v1/rgstr")&&(await s.clone().json())?.success){const e=new CustomEvent("rgstrEventReceived",{detail:{payload:f}});window.dispatchEvent(e)}return s};
